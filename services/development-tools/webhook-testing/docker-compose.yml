services:
  hoppscotch-db:
    image: postgres:17-alpine
    container_name: hoppscotch-db
    profiles:
    - webhook-testing
    restart: unless-stopped
    volumes:
    - hoppscotch_postgres:/var/lib/postgresql/data
    env_file:
      - .env
    environment:
    - POSTGRES_DB=hoppscotch
    - POSTGRES_USER=hoppscotch
    - POSTGRES_PASSWORD=${HOPPSCOTCH_DB_PASSWORD}
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U hoppscotch
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  webhook-tester-redis:
    image: redis:7-alpine
    container_name: webhook-tester-redis
    env_file:
      - .env
    profiles:
    - webhook-testing
    restart: unless-stopped
    volumes:
    - webhook_tester_redis:/data
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 5
  webhook-tester:
    image: ghcr.io/tarampampam/webhook-tester:2
    container_name: webhook-tester
    profiles:
    - webhook-testing
    restart: unless-stopped
    env_file:
      - .env
    environment:
    - AUTO_CREATE_SESSIONS=true
    - STORAGE_DRIVER=redis
    - PUBSUB_DRIVER=redis
    - REDIS_DSN=redis://webhook-tester-redis:6379/0
    - MAX_REQUESTS=100
    - IGNORE_HEADER_PREFIX=X-Forwarded-
    - IGNORE_HEADER_PREFIX=X-Real-
    depends_on:
      webhook-tester-redis:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - wget
      - -q
      - --spider
      - http://localhost:8080
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  hoppscotch-migrate:
    image: hoppscotch/hoppscotch:latest
    container_name: hoppscotch-migrate
    profiles:
    - webhook-testing
    env_file:
      - .env
    environment:
    - DATABASE_URL=postgresql://hoppscotch:${HOPPSCOTCH_DB_PASSWORD}@hoppscotch-db:5432/hoppscotch
    depends_on:
      hoppscotch-db:
        condition: service_healthy
    command: sh -c "pnpx prisma migrate deploy --schema /dist/backend/prisma/schema.prisma"
    restart: 'no'
  hoppscotch:
    image: hoppscotch/hoppscotch:latest
    container_name: hoppscotch
    profiles:
    - webhook-testing
    restart: unless-stopped
    env_file:
      - .env
    environment:
    - DATABASE_URL=postgresql://hoppscotch:${HOPPSCOTCH_DB_PASSWORD}@hoppscotch-db:5432/hoppscotch
    - ENABLE_SUBPATH_BASED_ACCESS=false
    - JWT_SECRET=${HOPPSCOTCH_JWT_SECRET}
    - SESSION_SECRET=${HOPPSCOTCH_SESSION_SECRET}
    - REFRESH_TOKEN_SECRET=${HOPPSCOTCH_REFRESH_TOKEN_SECRET}
    - DATA_ENCRYPTION_KEY=${HOPPSCOTCH_DATA_ENCRYPTION_KEY}
    - REDIRECT_URL=https://${HOPPSCOTCH_HOSTNAME}
    - WHITELISTED_ORIGINS=https://${HOPPSCOTCH_HOSTNAME}
    - VITE_BASE_URL=https://${HOPPSCOTCH_HOSTNAME}
    - VITE_SHORTCODE_BASE_URL=https://${HOPPSCOTCH_HOSTNAME}
    - VITE_ADMIN_URL=https://${HOPPSCOTCH_HOSTNAME}
    - MAILER_SMTP_ENABLE=true
    - MAILER_USE_CUSTOM_CONFIGS=true
    - MAILER_SMTP_HOST=mailpit
    - MAILER_SMTP_PORT=1025
    - MAILER_SMTP_SECURE=false
    - MAILER_SMTP_AUTH=false
    - MAILER_ADDRESS_FROM=hoppscotch@${BASE_DOMAIN}
    - RATE_LIMIT_TTL=60
    - RATE_LIMIT_MAX=100
    - VITE_ALLOWED_AUTH_PROVIDERS=EMAIL
    volumes:
    - ${PROJECT_ROOT}/services/.shared-resources/shared:/data/shared
    depends_on:
      hoppscotch-db:
        condition: service_healthy
      hoppscotch-migrate:
        condition: service_completed_successfully
    healthcheck:
      test:
      - CMD-SHELL
      - curl -fsS http://localhost:3000/api/health || curl -fsS http://localhost:3000
        || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
volumes:
  hoppscotch_postgres: {}
  webhook_tester_redis: {}
