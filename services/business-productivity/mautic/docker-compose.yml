services:
  mautic_redis:
    image: redis:7-alpine
    container_name: mautic_redis
    env_file:
      - .env
    profiles:
    - mautic
    restart: unless-stopped
    volumes:
    - mautic_redis_data:/data
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 30s
      timeout: 10s
      retries: 5
  mautic_worker:
    image: mautic/mautic:latest
    container_name: mautic_worker
    profiles:
    - mautic
    restart: unless-stopped
    depends_on:
      mautic_web:
        condition: service_healthy
    volumes:
    - mautic_data:/var/www/html
    - ${PROJECT_ROOT}/services/.shared-resources/shared:/data/shared
    env_file:
      - .env
    environment:
    - MAUTIC_DB_HOST=mautic_db
    - MAUTIC_DB_PORT=3306
    - MAUTIC_DB_NAME=mautic
    - MAUTIC_DB_USER=${MAUTIC_DB_USER}
    - MAUTIC_DB_PASSWORD=${MAUTIC_DB_PASSWORD}
    - MAUTIC_REDIS_HOST=mautic_redis
    - MAUTIC_REDIS_PORT=6379
    command: "sh -c \"\n  while true; do\n    php /var/www/html/bin/console mautic:segments:update\
      \ --no-interaction\n    php /var/www/html/bin/console mautic:campaigns:update\
      \ --no-interaction\n    php /var/www/html/bin/console mautic:campaigns:trigger\
      \ --no-interaction\n    php /var/www/html/bin/console mautic:messages:send --no-interaction\n\
      \    php /var/www/html/bin/console mautic:webhooks:process --no-interaction\n\
      \    php /var/www/html/bin/console mautic:reports:scheduler --no-interaction\n\
      \    php /var/www/html/bin/console mautic:import --no-interaction\n    sleep\
      \ 300\n  done\n\"\n"
  mautic_db:
    image: mariadb:10.11
    container_name: mautic_db
    profiles:
    - mautic
    restart: unless-stopped
    volumes:
    - mautic_db_data:/var/lib/mysql
    env_file:
      - .env
    environment:
    - MYSQL_ROOT_PASSWORD=${MAUTIC_DB_ROOT_PASSWORD}
    - MYSQL_DATABASE=mautic
    - MYSQL_USER=${MAUTIC_DB_USER}
    - MYSQL_PASSWORD=${MAUTIC_DB_PASSWORD}
    healthcheck:
      test:
      - CMD-SHELL
      - mysqladmin ping -h localhost -u root -p${MAUTIC_DB_ROOT_PASSWORD}
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
  mautic_web:
    image: mautic/mautic:latest
    container_name: mautic_web
    profiles:
    - mautic
    restart: unless-stopped
    depends_on:
      mautic_db:
        condition: service_healthy
      mautic_redis:
        condition: service_healthy
    volumes:
    - mautic_data:/var/www/html
    - ${PROJECT_ROOT}/services/.shared-resources/shared:/data/shared
    env_file:
      - .env
    environment:
    - MAUTIC_DB_HOST=mautic_db
    - MAUTIC_DB_PORT=3306
    - MAUTIC_DB_NAME=mautic
    - MAUTIC_DB_USER=${MAUTIC_DB_USER}
    - MAUTIC_DB_PASSWORD=${MAUTIC_DB_PASSWORD}
    - MAUTIC_REDIS_HOST=mautic_redis
    - MAUTIC_REDIS_PORT=6379
    - MAUTIC_ADMIN_EMAIL=${MAUTIC_ADMIN_EMAIL}
    - MAUTIC_ADMIN_PASSWORD=${MAUTIC_ADMIN_PASSWORD}
    - MAUTIC_TRUSTED_PROXIES=["0.0.0.0/0"]
    - MAUTIC_URL=https://${MAUTIC_HOSTNAME}
    - MAUTIC_MAILER_DSN=smtp://mailpit:1025
    - PHP_MEMORY_LIMIT=512M
    - PHP_MAX_EXECUTION_TIME=300
    - PHP_UPLOAD_MAX_FILESIZE=50M
    - PHP_POST_MAX_SIZE=50M
    healthcheck:
      test:
      - CMD-SHELL
      - curl -fsS http://localhost/s/login || exit 1
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 60s
volumes:
  mautic_redis_data: {}
  mautic_data: {}
  mautic_db_data: {}
