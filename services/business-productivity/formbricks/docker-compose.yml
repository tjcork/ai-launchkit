services:
  formbricks:
    image: formbricks/formbricks:latest
    container_name: formbricks
    profiles:
    - formbricks
    restart: unless-stopped
    volumes:
    - formbricks_uploads:/home/nextjs/apps/web/uploads
    - ${PROJECT_ROOT}/services/.shared-resources/shared:/data/shared
    env_file:
      - .env
    environment:
    - WEBAPP_URL=https://${FORMBRICKS_HOSTNAME}
    - NEXTAUTH_URL=https://${FORMBRICKS_HOSTNAME}
    - DATABASE_URL=postgresql://formbricks:${FORMBRICKS_DB_PASSWORD:-formbricks_secure_password}@formbricks_db:5432/formbricks?schema=public
    - NEXTAUTH_SECRET=${FORMBRICKS_NEXTAUTH_SECRET}
    - ENCRYPTION_KEY=${FORMBRICKS_ENCRYPTION_KEY}
    - CRON_SECRET=${FORMBRICKS_CRON_SECRET}
    - EMAIL_VERIFICATION_DISABLED=1
    - PASSWORD_RESET_DISABLED=0
    - INVITE_DISABLED=0
    - EMAIL_AUTH_DISABLED=0
    - MAIL_FROM=${FORMBRICKS_MAIL_FROM:-noreply@${BASE_DOMAIN}}
    - SMTP_HOST=${SMTP_HOST:-mailpit}
    - SMTP_PORT=${SMTP_PORT:-1025}
    - SMTP_USER=${SMTP_USER:-dummy}
    - SMTP_PASSWORD=${SMTP_PASS:-dummy}
    - SMTP_SECURE_ENABLED=0
    - UPLOADS_DIR=/home/nextjs/apps/web/uploads
    - ASSET_PREFIX_URL=
    - TELEMETRY_DISABLED=1
    - DEFAULT_ORGANIZATION_ID=
    - DEFAULT_ORGANIZATION_ROLE=owner
    - REDIS_URL=redis://redis:6379
    - REDIS_HTTP_URL=redis://redis:6379
    depends_on:
      formbricks_db:
        condition: service_healthy
    healthcheck:
      test:
      - CMD-SHELL
      - curl -fsS http://localhost:3000/api/v1/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
  formbricks_db:
    image: pgvector/pgvector:pg17
    container_name: formbricks_db
    profiles:
    - formbricks
    restart: unless-stopped
    volumes:
    - formbricks_postgres:/var/lib/postgresql/data
    env_file:
      - .env
    environment:
    - POSTGRES_DB=formbricks
    - POSTGRES_USER=formbricks
    - POSTGRES_PASSWORD=${FORMBRICKS_DB_PASSWORD:-formbricks_secure_password}
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U formbricks
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
  formbricks-init:
    image: postgres:${POSTGRES_VERSION:-17}
    container_name: formbricks-init
    profiles:
    - formbricks
    env_file:
      - .env
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD}
    command: 'sh -c " psql -h postgres -U postgres -c \"CREATE DATABASE formbricks\"
      || true && echo ''Formbricks database ready'' "

      '
    restart: 'no'
volumes:
  formbricks_uploads: {}
  formbricks_postgres: {}
