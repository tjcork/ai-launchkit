services:
  kimai:
    image: kimai/kimai2:apache
    container_name: kimai
    profiles:
    - kimai
    restart: unless-stopped
    volumes:
    - kimai_data:/opt/kimai/var/data
    - kimai_plugins:/opt/kimai/var/plugins
    - ${PROJECT_ROOT}/services/.shared-resources/shared:/data/shared
    env_file:
      - .env
    environment:
    - ADMINMAIL=${KIMAI_ADMIN_EMAIL:-${PRIMARY_EMAIL}}
    - ADMINPASS=${KIMAI_ADMIN_PASSWORD}
    - DATABASE_URL=mysql://${KIMAI_DB_USER}:${KIMAI_DB_PASSWORD}@kimai_db:3306/${KIMAI_DB_NAME}?charset=utf8mb4&serverVersion=8.3.0
    - TRUSTED_HOSTS=${KIMAI_HOSTNAME},localhost,127.0.0.1
    - APP_ENV=prod
    - memory_limit=256M
    - MAILER_URL=smtp://${SMTP_HOST:-mailpit}:${SMTP_PORT:-1025}
    - MAILER_FROM=${KIMAI_MAIL_FROM:-kimai@${BASE_DOMAIN}}
    - memory_limit=512M
    - post_max_size=50M
    - upload_max_filesize=50M
    depends_on:
      kimai_db:
        condition: service_healthy
    healthcheck:
      test:
      - CMD-SHELL
      - curl -fsS http://localhost:8001 || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
  kimai_db:
    image: mysql:8.3
    container_name: kimai_db
    profiles:
    - kimai
    restart: unless-stopped
    volumes:
    - kimai_mysql:/var/lib/mysql
    env_file:
      - .env
    environment:
    - MYSQL_DATABASE=${KIMAI_DB_NAME:-kimai}
    - MYSQL_USER=${KIMAI_DB_USER:-kimai}
    - MYSQL_PASSWORD=${KIMAI_DB_PASSWORD}
    - MYSQL_ROOT_PASSWORD=${KIMAI_DB_ROOT_PASSWORD}
    command: --default-storage-engine=innodb --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test:
      - CMD
      - mysqladmin
      - ping
      - -h
      - localhost
      - -u
      - root
      - -p${KIMAI_DB_ROOT_PASSWORD}
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
volumes:
  kimai_plugins: {}
  kimai_data: {}
  kimai_mysql: {}
