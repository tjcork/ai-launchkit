services:
  nocodb:
    image: nocodb/nocodb:latest
    container_name: nocodb
    profiles:
    - nocodb
    restart: unless-stopped
    volumes:
    - nocodb_data:/usr/app/data
    - ${PROJECT_ROOT}/services/.shared-resources/shared:/data/shared
    env_file:
      - .env
    environment:
    - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/nocodb
    - NC_AUTH_JWT_SECRET=${NOCODB_JWT_SECRET}
    - NC_DISABLE_TELE=true
    depends_on:
      nocodb-init:
        condition: service_completed_successfully
    healthcheck:
      test:
      - CMD-SHELL
      - curl -fsS http://localhost:8080/api/v1/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
  nocodb-init:
    image: postgres:${POSTGRES_VERSION:-17}
    container_name: nocodb-init
    profiles:
    - nocodb
    env_file:
      - .env
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD}
    command: 'sh -c " psql -h postgres -U postgres -c \"CREATE DATABASE nocodb\" ||
      true && echo ''NocoDB database ready'' "

      '
    restart: 'no'
volumes:
  nocodb_data: {}
