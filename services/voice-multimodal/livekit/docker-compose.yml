services:
  livekit-server:
    image: livekit/livekit-server:latest
    container_name: livekit-server
    profiles:
    - livekit
    restart: unless-stopped
    volumes:
    - livekit_data:/data
    - ./config/entrypoint.sh:/entrypoint.sh:ro
    env_file:
      - .env
    environment:
    - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
    - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
    entrypoint:
    - /bin/sh
    - /entrypoint.sh
    ports:
    - 7880:7880
    - 7882:7882/tcp
    - 50000-50100:50000-50100/udp
    healthcheck:
      test:
      - CMD
      - wget
      - -q
      - --spider
      - http://localhost:7880
      interval: 30s
      timeout: 10s
      retries: 5
  livekit-agents:
    image: python:3.11-slim
    container_name: livekit-agents
    profiles:
    - livekit
    restart: unless-stopped
    working_dir: /app
    volumes:
    - ./agents:/app
    - ${PROJECT_ROOT}/services/.shared-resources/shared:/data/shared
    env_file:
      - .env
    environment:
    - LIVEKIT_URL=ws://livekit-server:7880
    - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
    - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
    - WHISPER_URL=http://faster-whisper:8000
    - TTS_URL=http://openedai-speech:8000
    - OLLAMA_URL=http://ollama:11434
    - OPENAI_API_KEY=${OPENAI_API_KEY}
    - OLLAMA_MODEL=${OLLAMA_MODEL}
    depends_on:
    - livekit-server
    command: 'bash -c " pip install livekit-agents livekit-plugins-openai livekit-plugins-silero
      && python agent.py start "

      '
volumes:
  livekit_data: {}
