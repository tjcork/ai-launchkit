services:
  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    profiles:
    - gitea
    restart: unless-stopped
    depends_on:
    - gitea-db
    env_file:
      - .env
    environment:
    - USER_UID=1000
    - USER_GID=1000
    - GITEA__database__DB_TYPE=postgres
    - GITEA__database__HOST=gitea-db:5432
    - GITEA__database__NAME=gitea
    - GITEA__database__USER=gitea
    - GITEA__database__PASSWD=gitea
    ports:
    - ${GITEA_SSH_PORT:-2222}:22
    volumes:
    - gitea_data:/data
    - /etc/timezone:/etc/timezone:ro
    - /etc/localtime:/etc/localtime:ro
  gitea-db:
    image: postgres:17-alpine
    container_name: gitea-db
    profiles:
    - gitea
    restart: unless-stopped
    env_file:
      - .env
    environment:
    - POSTGRES_USER=gitea
    - POSTGRES_PASSWORD=gitea
    - POSTGRES_DB=gitea
    volumes:
    - gitea_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U gitea
      interval: 30s
      timeout: 10s
      retries: 3
volumes:
  gitea_data: {}
  gitea_postgres_data: {}
