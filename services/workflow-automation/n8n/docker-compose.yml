services:
  n8n:
    build:
      context: .
      pull: true
    environment:
      DB_POSTGRESDB_DATABASE: postgres
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_USER: postgres
      DB_TYPE: postgresdb
      EXECUTIONS_MODE: queue
      LANGCHAIN_API_KEY: ${LANGCHAIN_API_KEY}
      LANGCHAIN_ENDPOINT: ${LANGCHAIN_ENDPOINT}
      LANGCHAIN_TRACING_V2: ${LANGCHAIN_TRACING_V2}
      N8N_BINARY_DATA_MODE: filesystem
      N8N_PAYLOAD_SIZE_MAX: 256
      N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE: true
      N8N_DIAGNOSTICS_ENABLED: false
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
      N8N_METRICS: true
      N8N_PERSONALIZATION_ENABLED: false
      N8N_RUNNERS_ENABLED: true
      N8N_RUNNERS_MODE: external
      N8N_RUNNERS_BROKER_LISTEN_ADDRESS: 0.0.0.0
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
      N8N_NATIVE_PYTHON_RUNNER: true
      N8N_TRUST_PROXY: true
      N8N_USER_MANAGEMENT_JWT_SECRET: ${N8N_USER_MANAGEMENT_JWT_SECRET}
      NODE_ENV: production
      NODE_FUNCTION_ALLOW_BUILTIN: '*'
      NODE_FUNCTION_ALLOW_EXTERNAL: cheerio,axios,moment,lodash
      QUEUE_BULL_REDIS_HOST: ${REDIS_HOST:-redis}
      QUEUE_BULL_REDIS_PORT: ${REDIS_PORT:-6379}
      QUEUE_HEALTH_CHECK_ACTIVE: true
      WEBHOOK_URL: ${N8N_HOSTNAME:+https://}${N8N_HOSTNAME:-http://localhost:5678}/
    container_name: n8n
    profiles:
    - n8n
    restart: unless-stopped
    ports:
    - 127.0.0.1:5678:5678
    volumes:
    - n8n_storage:/home/node/.n8n
    - ./backup:/backup
    - ../../shared-resources/shared:/data/shared
    - ../../shared-resources/media:/data/media
    - ../../shared-resources/temp:/data/temp
    depends_on:
      n8n-import:
        condition: service_completed_successfully
  n8n-worker:
    build:
      context: .
      pull: true
    environment:
      DB_POSTGRESDB_DATABASE: postgres
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_USER: postgres
      DB_TYPE: postgresdb
      EXECUTIONS_MODE: queue
      LANGCHAIN_API_KEY: ${LANGCHAIN_API_KEY}
      LANGCHAIN_ENDPOINT: ${LANGCHAIN_ENDPOINT}
      LANGCHAIN_TRACING_V2: ${LANGCHAIN_TRACING_V2}
      N8N_BINARY_DATA_MODE: filesystem
      N8N_PAYLOAD_SIZE_MAX: 256
      N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE: true
      N8N_DIAGNOSTICS_ENABLED: false
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
      N8N_METRICS: true
      N8N_PERSONALIZATION_ENABLED: false
      N8N_RUNNERS_ENABLED: true
      N8N_RUNNERS_MODE: external
      N8N_RUNNERS_BROKER_LISTEN_ADDRESS: 0.0.0.0
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
      N8N_NATIVE_PYTHON_RUNNER: true
      N8N_TRUST_PROXY: true
      N8N_USER_MANAGEMENT_JWT_SECRET: ${N8N_USER_MANAGEMENT_JWT_SECRET}
      NODE_ENV: production
      NODE_FUNCTION_ALLOW_BUILTIN: '*'
      NODE_FUNCTION_ALLOW_EXTERNAL: cheerio,axios,moment,lodash
      QUEUE_BULL_REDIS_HOST: ${REDIS_HOST:-redis}
      QUEUE_BULL_REDIS_PORT: ${REDIS_PORT:-6379}
      QUEUE_HEALTH_CHECK_ACTIVE: true
      WEBHOOK_URL: ${N8N_HOSTNAME:+https://}${N8N_HOSTNAME:-http://localhost:5678}/
    profiles:
    - n8n
    restart: unless-stopped
    command: worker
    volumes:
    - n8n_storage:/home/node/.n8n
    - ../../shared-resources/shared:/data/shared
    - ../../shared-resources/media:/data/media
    - ../../shared-resources/temp:/data/temp
    depends_on:
      n8n:
        condition: service_started
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    deploy:
      replicas: ${N8N_WORKER_COUNT:-1}
  n8n-runner:
    image: n8nio/runners:${N8N_RUNNERS_VERSION}
    container_name: n8n-runner
    profiles:
    - n8n
    restart: unless-stopped
    environment:
    - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
    - N8N_RUNNERS_TASK_BROKER_URI=http://n8n:5679
    - N8N_RUNNERS_MAX_CONCURRENCY=5
    - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=15
    - NODE_OPTIONS=--max-old-space-size=512
    - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-Europe/Berlin}
    - N8N_RUNNERS_PYTHON_ALLOW_BUILTIN=*
    - N8N_RUNNERS_PYTHON_ALLOW_EXTERNAL=
    volumes:
    - ../../shared-resources/shared:/data/shared
    - ./task-runners.json:/etc/n8n-task-runners.json:ro
    depends_on:
      n8n:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:5680/healthz
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  n8n-import:
    build:
      context: ${PROJECT_ROOT}/n8n
      pull: true
    environment:
      DB_POSTGRESDB_DATABASE: postgres
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_USER: postgres
      DB_TYPE: postgresdb
      EXECUTIONS_MODE: queue
      LANGCHAIN_API_KEY: ${LANGCHAIN_API_KEY}
      LANGCHAIN_ENDPOINT: ${LANGCHAIN_ENDPOINT}
      LANGCHAIN_TRACING_V2: ${LANGCHAIN_TRACING_V2}
      N8N_BINARY_DATA_MODE: filesystem
      N8N_PAYLOAD_SIZE_MAX: 256
      N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE: true
      N8N_DIAGNOSTICS_ENABLED: false
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
      N8N_METRICS: true
      N8N_PERSONALIZATION_ENABLED: false
      N8N_RUNNERS_ENABLED: true
      N8N_RUNNERS_MODE: external
      N8N_RUNNERS_BROKER_LISTEN_ADDRESS: 0.0.0.0
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
      N8N_NATIVE_PYTHON_RUNNER: true
      N8N_TRUST_PROXY: true
      N8N_USER_MANAGEMENT_JWT_SECRET: ${N8N_USER_MANAGEMENT_JWT_SECRET}
      NODE_ENV: production
      NODE_FUNCTION_ALLOW_BUILTIN: '*'
      NODE_FUNCTION_ALLOW_EXTERNAL: cheerio,axios,moment,lodash
      QUEUE_BULL_REDIS_HOST: ${REDIS_HOST:-redis}
      QUEUE_BULL_REDIS_PORT: ${REDIS_PORT:-6379}
      QUEUE_HEALTH_CHECK_ACTIVE: true
      WEBHOOK_URL: ${N8N_HOSTNAME:+https://}${N8N_HOSTNAME:-http://localhost:5678}/
      RUN_N8N_IMPORT: ${RUN_N8N_IMPORT:-false}
    container_name: n8n-import
    profiles:
    - n8n
    entrypoint: /bin/sh
    command: /scripts/n8n_import_script.sh
    volumes:
    - ./backup:/backup
    - ./n8n_import_script.sh:/scripts/n8n_import_script.sh:ro
    depends_on:
      postgres:
        condition: service_healthy
volumes:
  n8n_storage: {}
