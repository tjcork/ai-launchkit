services:
  coredns-private:
    image: coredns/coredns:latest
    container_name: coredns-private
    restart: unless-stopped
    env_file:
      - ../../.env
    entrypoint: ["/bin/sh", "-c"]
    command: ["envsubst < /etc/coredns/Corefile.template > /etc/coredns/Corefile && exec /coredns -conf /etc/coredns/Corefile"]
    volumes:
      - ./Corefile.template:/etc/coredns/Corefile.template:ro
    ports:
      - "${PRIVATE_DNS_TARGET_IP}:53:53/udp"
      - "${PRIVATE_DNS_TARGET_IP}:53:53/tcp"
    healthcheck:
      test: ["CMD-SHELL", "dig @${PRIVATE_DNS_TARGET_IP} mail.${BASE_DOMAIN:-example.com} +short | grep -q ${PRIVATE_DNS_TARGET_IP}"]
      interval: 30s
      timeout: 5s
      retries: 3
